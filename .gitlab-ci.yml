cache:
  key: "$CI_PROJECT_ID"
  paths:
  - node_modules/

stages:
- build
- deploy

building:
  stage: build
  variables:
    NODE_ENV: "production"
  script:
  - npm i --no-optional
  - npm run build
  artifacts:
    expire_in: 1 hour
    paths:
    - .nuxt/dist
  only:
  - master

deploy:
  stage: deploy
  only:
  - master
  script:
  - cp -R ./.nuxt/dist/* /opt/app/dist/
  - cp -f ./vibrant.js /opt/app/
  - cp -f ./webp.js /opt/app/
  - cp -f ./ecosystem.config.js /opt/app/
  - npm i -g pm2
  - npm i -g express
  - npm i -g node-vibrant
  - npm i -g webp-converter
  - cd /opt/app
  - pm2 deploy production
  tags:
  - shell
